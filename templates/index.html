<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seismic Wavelet Sonifier</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .main-content {
            display: flex;
            height: calc(100vh - 140px);
            min-height: 600px;
        }

        .control-panel {
            width: 350px;
            min-width: 350px;
            background: #f8f9fa;
            padding: 30px;
            border-right: 1px solid #e9ecef;
            overflow-y: auto;
            max-height: 100vh;
        }

        .plot-area {
            flex: 1;
            padding: 30px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 600px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 13px;
        }

        .form-control {
            width: 100%;
            padding: 8px 10px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            font-size: 13px;
            transition: border-color 0.3s ease;
            height: 32px;
        }

        .form-control:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            height: 36px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(86, 171, 47, 0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(255, 65, 108, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .button-group {
            display: flex;
            gap: 8px;
            margin-top: 15px;
        }

        .button-group .btn {
            flex: 1;
        }

        .plot-container {
            width: 100%;
            max-width: 800px;
            text-align: center;
            flex-shrink: 0;
        }

        .plot-image {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #f5c6cb;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border: 1px solid #c3e6cb;
        }

        .parameter-section {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .parameter-section h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .hidden {
            display: none;
        }

        .audio-controls {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            width: 100%;
            max-width: 800px;
        }

        .audio-controls h3 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .audio-info {
            font-size: 12px;
            color: #6c757d;
            line-height: 1.4;
            flex: 1;
        }

        .audio-controls-row {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-top: 10px;
        }

        .audio-button-container {
            flex-shrink: 0;
        }

        .btn-audio {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
            border: none;
            transition: all 0.3s ease;
        }

        .btn-audio:hover:not(:disabled) {
            transform: scale(1.1);
            box-shadow: 0 8px 20px rgba(86, 171, 47, 0.4);
        }

        .btn-audio:active:not(:disabled) {
            transform: scale(0.95);
        }

        .btn-audio.playing {
            background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
        }

        .btn-audio.playing:hover:not(:disabled) {
            box-shadow: 0 8px 20px rgba(255, 65, 108, 0.4);
        }

        .play-icon, .stop-icon {
            display: inline-block;
            transition: opacity 0.3s ease;
        }

        .play-icon.hidden, .stop-icon.hidden {
            opacity: 0;
            position: absolute;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e9ecef;
            outline: none;
            -webkit-appearance: none;
            appearance: none;
            margin: 8px 0;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }

        .slider::-moz-range-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .slider::-webkit-slider-track {
            background: #e9ecef;
            height: 6px;
            border-radius: 3px;
        }

        .slider::-moz-range-track {
            background: #e9ecef;
            height: 6px;
            border-radius: 3px;
            border: none;
        }

        .form-group label span {
            font-weight: bold;
            color: #667eea;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Seismic Wavelet Sonifier</h1>
            <p>Generate and analyze seismic wavelets with real-time audio playback</p>
        </div>

        <div class="main-content">
            <div class="control-panel">
                <div class="parameter-section">
                    <h3>Wavelet Parameters</h3>
                    
                    <div class="form-group">
                        <label for="waveletType">Wavelet Type:</label>
                        <select id="waveletType" class="form-control">
                            <option value="Ricker">Ricker</option>
                            <option value="Ormsby">Ormsby</option>
                            <option value="Klauder">Klauder</option>
                            <option value="Berlage">Berlage</option>
                        </select>
                    </div>

                    <!-- Ricker Parameters -->
                    <div id="rickerParams" class="wavelet-params">
                        <div class="form-group">
                            <label for="rickerFreq">Frequency (Hz): <span id="rickerFreqValue">60</span></label>
                            <input type="range" id="rickerFreq" class="slider" value="60" min="10" max="490">
                        </div>
                        <div class="form-group">
                            <label for="rickerLength">Length (s): <span id="rickerLengthValue">0.5</span></label>
                            <input type="range" id="rickerLength" class="slider" value="0.5" min="0.1" max="2.0" step="0.1">
                        </div>
                    </div>

                    <!-- Ormsby Parameters -->
                    <div id="ormsbyParams" class="wavelet-params hidden">
                        <div class="form-group">
                            <label for="ormsbyF1">f1 (Hz): <span id="ormsbyF1Value">30</span></label>
                            <input type="range" id="ormsbyF1" class="slider" value="30" min="10" max="490">
                        </div>
                        <div class="form-group">
                            <label for="ormsbyF2">f2 (Hz): <span id="ormsbyF2Value">40</span></label>
                            <input type="range" id="ormsbyF2" class="slider" value="40" min="10" max="490">
                        </div>
                        <div class="form-group">
                            <label for="ormsbyF3">f3 (Hz): <span id="ormsbyF3Value">90</span></label>
                            <input type="range" id="ormsbyF3" class="slider" value="90" min="10" max="490">
                        </div>
                        <div class="form-group">
                            <label for="ormsbyF4">f4 (Hz): <span id="ormsbyF4Value">100</span></label>
                            <input type="range" id="ormsbyF4" class="slider" value="100" min="10" max="490">
                        </div>
                        <div class="form-group">
                            <label for="ormsbyLength">Length (s): <span id="ormsbyLengthValue">0.5</span></label>
                            <input type="range" id="ormsbyLength" class="slider" value="0.5" min="0.1" max="2.0" step="0.1">
                        </div>
                    </div>

                    <!-- Klauder Parameters -->
                    <div id="klauderParams" class="wavelet-params hidden">
                        <div class="form-group">
                            <label for="klauderF1">f1 (Hz): <span id="klauderF1Value">40</span></label>
                            <input type="range" id="klauderF1" class="slider" value="40" min="10" max="490">
                        </div>
                        <div class="form-group">
                            <label for="klauderF2">f2 (Hz): <span id="klauderF2Value">90</span></label>
                            <input type="range" id="klauderF2" class="slider" value="90" min="10" max="490">
                        </div>
                        <div class="form-group">
                            <label for="klauderLength">Length (s): <span id="klauderLengthValue">0.5</span></label>
                            <input type="range" id="klauderLength" class="slider" value="0.5" min="0.1" max="2.0" step="0.1">
                        </div>
                    </div>

                    <!-- Berlage Parameters -->
                    <div id="berlageParams" class="wavelet-params hidden">
                        <div class="form-group">
                            <label for="berlageFreq">Frequency (Hz): <span id="berlageFreqValue">60</span></label>
                            <input type="range" id="berlageFreq" class="slider" value="60" min="10" max="490">
                        </div>
                        <div class="form-group">
                            <label for="berlageLength">Length (s): <span id="berlageLengthValue">0.5</span></label>
                            <input type="range" id="berlageLength" class="slider" value="0.5" min="0.1" max="2.0" step="0.1">
                        </div>
                    </div>

                    <!-- Common Parameters -->
                    <div class="form-group">
                        <label for="dt">Sampling Interval (dt):</label>
                        <input type="number" id="dt" class="form-control" value="0.001" step="0.0001" min="0.0001" max="0.004">
                    </div>
                </div>

                <div class="button-group">
                    <button id="generateBtn" class="btn btn-primary">Generate Wavelet</button>
                </div>
            </div>

            <div class="plot-area">
                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Generating wavelet...</p>
                </div>
                
                <div class="plot-container" id="plotContainer">
                    <p style="color: #6c757d; font-size: 1.2em;">Click "Generate Wavelet" to create a plot</p>
                </div>

                <div class="audio-controls">
                    <h3>Audio Playback</h3>
                    <div class="audio-controls-row">
                        <div class="audio-button-container">
                            <button id="playStopBtn" class="btn btn-audio" disabled>
                                <span class="play-icon">▶</span>
                                <span class="stop-icon hidden">⏹</span>
                            </button>
                        </div>
                        <div class="audio-info">
                            <div>Original Sample Rate: <span id="sampleRate">-</span> Hz</div>
                            <div>Playback Sample Rate: <span id="playbackSampleRate">-</span> Hz</div>
                            <div>Duration: <span id="duration">-</span> s</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class WaveletApp {
            constructor() {
                this.audioContext = null;
                this.audioBuffer = null;
                this.isPlaying = false;
                this.currentAudioSource = null;
                
                this.initializeElements();
                this.attachEventListeners();
                this.initializeSliderValues();
                this.updateFrequencyLimits();
                
                // Автоматически генерируем вейвлет при загрузке
                this.generateWavelet();
            }

            initializeSliderValues() {
                const sliders = document.querySelectorAll('.slider');
                sliders.forEach(slider => {
                    this.updateSliderValue(slider);
                });
            }

            initializeElements() {
                this.waveletTypeSelect = document.getElementById('waveletType');
                this.dtInput = document.getElementById('dt');
                this.generateBtn = document.getElementById('generateBtn');
                this.playStopBtn = document.getElementById('playStopBtn');
                this.playIcon = this.playStopBtn.querySelector('.play-icon');
                this.stopIcon = this.playStopBtn.querySelector('.stop-icon');
                this.loading = document.getElementById('loading');
                this.plotContainer = document.getElementById('plotContainer');
                this.sampleRateSpan = document.getElementById('sampleRate');
                this.playbackSampleRateSpan = document.getElementById('playbackSampleRate');
                this.durationSpan = document.getElementById('duration');
            }

            attachEventListeners() {
                this.waveletTypeSelect.addEventListener('change', () => {
                    this.updateParameterVisibility();
                    this.validateFrequencies();
                });
                this.dtInput.addEventListener('input', () => this.updateFrequencyLimits());
                this.generateBtn.addEventListener('click', () => this.generateWavelet());
                this.playStopBtn.addEventListener('click', () => this.toggleAudio());
                
                // Добавляем валидацию при изменении частот
                this.addFrequencyValidationListeners();
            }

            addFrequencyValidationListeners() {
                const frequencyInputs = document.querySelectorAll('input[id$="Freq"], input[id$="F1"], input[id$="F2"], input[id$="F3"], input[id$="F4"], input[id$="Length"]');
                frequencyInputs.forEach(input => {
                    input.addEventListener('input', () => {
                        this.updateSliderValue(input);
                        this.autoCorrectFrequencies();
                        this.validateFrequencies();
                    });
                });
            }

            updateSliderValue(slider) {
                const valueSpan = document.getElementById(slider.id + 'Value');
                if (valueSpan) {
                    valueSpan.textContent = slider.value;
                }
            }

            updateParameterVisibility() {
                const waveletType = this.waveletTypeSelect.value;
                const paramDivs = document.querySelectorAll('.wavelet-params');
                
                paramDivs.forEach(div => div.classList.add('hidden'));
                
                const activeDiv = document.getElementById(waveletType.toLowerCase() + 'Params');
                if (activeDiv) {
                    activeDiv.classList.remove('hidden');
                }
                
                // Добавляем валидацию для новых элементов
                this.addFrequencyValidationListeners();
            }

            async updateFrequencyLimits() {
                try {
                    const dt = parseFloat(this.dtInput.value);
                    const response = await fetch('/api/get_frequency_limits', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ dt: dt })
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const frequencyInputs = document.querySelectorAll('input[id$="Freq"], input[id$="F1"], input[id$="F2"], input[id$="F3"], input[id$="F4"]');
                        
                        frequencyInputs.forEach(input => {
                            input.min = 10; // Минимум 10 Гц
                            input.max = data.max_freq;
                            // Обновляем отображаемое значение
                            this.updateSliderValue(input);
                        });
                        
                        // Валидация текущих значений
                        this.validateFrequencies();
                    }
                } catch (error) {
                    console.error('Error updating frequency limits:', error);
                }
            }

            validateFrequencies() {
                const waveletType = this.waveletTypeSelect.value;
                const dt = parseFloat(this.dtInput.value);
                const nyquistFreq = 1.0 / (2.0 * dt);
                const maxFreq = nyquistFreq - 10;
                
                let isValid = true;
                let errorMessage = '';

                if (waveletType === 'Ricker' || waveletType === 'Berlage') {
                    const freq = parseFloat(document.getElementById(waveletType.toLowerCase() + 'Freq').value);
                    if (freq < 10) {
                        errorMessage = 'Frequency must be at least 10 Hz';
                        isValid = false;
                    } else if (freq > maxFreq) {
                        errorMessage = `Frequency must be at most ${maxFreq.toFixed(1)} Hz`;
                        isValid = false;
                    }
                } else if (waveletType === 'Klauder') {
                    const f1 = parseFloat(document.getElementById('klauderF1').value);
                    const f2 = parseFloat(document.getElementById('klauderF2').value);
                    
                    if (f1 < 10 || f2 < 10) {
                        errorMessage = 'Frequencies must be at least 10 Hz';
                        isValid = false;
                    } else if (f1 > maxFreq || f2 > maxFreq) {
                        errorMessage = `Frequencies must be at most ${maxFreq.toFixed(1)} Hz`;
                        isValid = false;
                    } else if (f1 >= f2) {
                        errorMessage = 'f1 must be less than f2';
                        isValid = false;
                    }
                } else if (waveletType === 'Ormsby') {
                    const f1 = parseFloat(document.getElementById('ormsbyF1').value);
                    const f2 = parseFloat(document.getElementById('ormsbyF2').value);
                    const f3 = parseFloat(document.getElementById('ormsbyF3').value);
                    const f4 = parseFloat(document.getElementById('ormsbyF4').value);
                    
                    if (f1 < 10 || f2 < 10 || f3 < 10 || f4 < 10) {
                        errorMessage = 'All frequencies must be at least 10 Hz';
                        isValid = false;
                    } else if (f1 > maxFreq || f2 > maxFreq || f3 > maxFreq || f4 > maxFreq) {
                        errorMessage = `All frequencies must be at most ${maxFreq.toFixed(1)} Hz`;
                        isValid = false;
                    } else if (f1 >= f2 || f2 >= f3 || f3 >= f4) {
                        errorMessage = 'Frequencies must be in ascending order: f1 < f2 < f3 < f4';
                        isValid = false;
                    }
                }

                // Обновляем состояние кнопки генерации
                this.generateBtn.disabled = !isValid;
                
                // Показываем сообщение об ошибке
                if (!isValid) {
                    this.showMessage(errorMessage, 'error');
                } else {
                    // Убираем сообщения об ошибках
                    const existingError = document.querySelector('.error');
                    if (existingError) {
                        existingError.remove();
                    }
                }
            }

            autoCorrectFrequencies() {
                const waveletType = this.waveletTypeSelect.value;
                
                if (waveletType === 'Klauder') {
                    const f1Slider = document.getElementById('klauderF1');
                    const f2Slider = document.getElementById('klauderF2');
                    const f1 = parseFloat(f1Slider.value);
                    const f2 = parseFloat(f2Slider.value);
                    
                    if (f1 >= f2) {
                        // Автоматически корректируем f2, чтобы f1 < f2
                        const newF2 = Math.min(parseFloat(f2Slider.max), f1 + 1);
                        f2Slider.value = newF2;
                        this.updateSliderValue(f2Slider);
                    }
                } else if (waveletType === 'Ormsby') {
                    const f1Slider = document.getElementById('ormsbyF1');
                    const f2Slider = document.getElementById('ormsbyF2');
                    const f3Slider = document.getElementById('ormsbyF3');
                    const f4Slider = document.getElementById('ormsbyF4');
                    
                    const f1 = parseFloat(f1Slider.value);
                    const f2 = parseFloat(f2Slider.value);
                    const f3 = parseFloat(f3Slider.value);
                    const f4 = parseFloat(f4Slider.value);
                    
                    // Корректируем порядок: f1 < f2 < f3 < f4
                    if (f1 >= f2) {
                        f2Slider.value = Math.min(parseFloat(f2Slider.max), f1 + 1);
                        this.updateSliderValue(f2Slider);
                    }
                    if (f2 >= f3) {
                        f3Slider.value = Math.min(parseFloat(f3Slider.max), f2 + 1);
                        this.updateSliderValue(f3Slider);
                    }
                    if (f3 >= f4) {
                        f4Slider.value = Math.min(parseFloat(f4Slider.max), f3 + 1);
                        this.updateSliderValue(f4Slider);
                    }
                }
            }

            async generateWavelet() {
                // Останавливаем воспроизведение, если оно идет
                if (this.isPlaying) {
                    this.stopAudio();
                }
                
                this.showLoading(true);
                
                try {
                    const parameters = this.getParameters();
                    const response = await fetch('/api/generate_wavelet', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(parameters)
                    });

                    const data = await response.json();

                    if (data.success) {
                        this.displayPlot(data.plot);
                        this.setupAudio(data.audio_data, data.sample_rate, data.time_data);
                    } else {
                        this.showMessage('Error: ' + data.error, 'error');
                    }
                } catch (error) {
                    this.showMessage('Error generating wavelet: ' + error.message, 'error');
                } finally {
                    this.showLoading(false);
                }
            }

            getParameters() {
                const waveletType = this.waveletTypeSelect.value;
                const dt = parseFloat(this.dtInput.value);
                
                const params = {
                    wavelet_type: waveletType,
                    dt: dt
                };

                switch (waveletType) {
                    case 'Ricker':
                        params.frequency = parseFloat(document.getElementById('rickerFreq').value);
                        params.length = parseFloat(document.getElementById('rickerLength').value);
                        break;
                    case 'Ormsby':
                        params.f1 = parseFloat(document.getElementById('ormsbyF1').value);
                        params.f2 = parseFloat(document.getElementById('ormsbyF2').value);
                        params.f3 = parseFloat(document.getElementById('ormsbyF3').value);
                        params.f4 = parseFloat(document.getElementById('ormsbyF4').value);
                        params.length = parseFloat(document.getElementById('ormsbyLength').value);
                        break;
                    case 'Klauder':
                        params.f1 = parseFloat(document.getElementById('klauderF1').value);
                        params.f2 = parseFloat(document.getElementById('klauderF2').value);
                        params.length = parseFloat(document.getElementById('klauderLength').value);
                        break;
                    case 'Berlage':
                        params.frequency = parseFloat(document.getElementById('berlageFreq').value);
                        params.length = parseFloat(document.getElementById('berlageLength').value);
                        break;
                }

                return params;
            }

            displayPlot(plotBase64) {
                this.plotContainer.innerHTML = `<img src="data:image/png;base64,${plotBase64}" class="plot-image" alt="Wavelet Plot">`;
            }

            setupAudio(audioData, sampleRate, timeData) {
                this.audioData = audioData;
                this.sampleRate = sampleRate;
                this.duration = timeData[timeData.length - 1] - timeData[0];
                
                this.sampleRateSpan.textContent = sampleRate;
                this.durationSpan.textContent = this.duration.toFixed(3);
                
                // Get the browser's audio context sample rate
                if (!this.audioContext) {
                    this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                this.playbackSampleRateSpan.textContent = this.audioContext.sampleRate;
                
                this.playStopBtn.disabled = false;
                this.updateButtonState(false);
            }

            async playAudio() {
                if (this.isPlaying) return;

                try {
                    if (!this.audioContext) {
                        this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    }

                    if (this.audioContext.state === 'suspended') {
                        await this.audioContext.resume();
                    }

                    // Resample audio data to a valid sample rate
                    const targetSampleRate = this.audioContext.sampleRate;
                    const resampledData = this.resampleAudio(this.audioData, this.sampleRate, targetSampleRate);

                    const audioBuffer = this.audioContext.createBuffer(1, resampledData.length, targetSampleRate);
                    const channelData = audioBuffer.getChannelData(0);
                    
                    for (let i = 0; i < resampledData.length; i++) {
                        channelData[i] = resampledData[i];
                    }

                    this.currentAudioSource = this.audioContext.createBufferSource();
                    this.currentAudioSource.buffer = audioBuffer;
                    this.currentAudioSource.loop = true;
                    this.currentAudioSource.connect(this.audioContext.destination);
                    this.currentAudioSource.start();

                    this.isPlaying = true;
                    this.updateButtonState(true);

                } catch (error) {
                    this.showMessage('Error playing audio: ' + error.message, 'error');
                }
            }

            resampleAudio(inputData, inputSampleRate, outputSampleRate) {
                if (inputSampleRate === outputSampleRate) {
                    return inputData;
                }

                const ratio = outputSampleRate / inputSampleRate;
                const outputLength = Math.floor(inputData.length * ratio);
                const outputData = new Float32Array(outputLength);

                for (let i = 0; i < outputLength; i++) {
                    const inputIndex = i / ratio;
                    const index = Math.floor(inputIndex);
                    const fraction = inputIndex - index;

                    if (index + 1 < inputData.length) {
                        // Linear interpolation
                        outputData[i] = inputData[index] * (1 - fraction) + inputData[index + 1] * fraction;
                    } else {
                        outputData[i] = inputData[index] || 0;
                    }
                }

                return outputData;
            }

            stopAudio() {
                if (this.currentAudioSource) {
                    this.currentAudioSource.stop();
                    this.currentAudioSource = null;
                }
                
                this.isPlaying = false;
                this.updateButtonState(false);
            }

            toggleAudio() {
                if (this.isPlaying) {
                    this.stopAudio();
                } else {
                    this.playAudio();
                }
            }

            updateButtonState(isPlaying) {
                if (isPlaying) {
                    this.playStopBtn.classList.add('playing');
                    this.playIcon.classList.add('hidden');
                    this.stopIcon.classList.remove('hidden');
                } else {
                    this.playStopBtn.classList.remove('playing');
                    this.playIcon.classList.remove('hidden');
                    this.stopIcon.classList.add('hidden');
                }
            }

            showLoading(show) {
                this.loading.style.display = show ? 'block' : 'none';
                this.plotContainer.style.display = show ? 'none' : 'block';
                this.generateBtn.disabled = show;
            }

            showMessage(message, type) {
                const existingMessage = document.querySelector('.error, .success');
                if (existingMessage) {
                    existingMessage.remove();
                }

                const messageDiv = document.createElement('div');
                messageDiv.className = type;
                messageDiv.textContent = message;
                
                this.plotContainer.insertBefore(messageDiv, this.plotContainer.firstChild);
                
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.remove();
                    }
                }, 5000);
            }
        }

        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new WaveletApp();
        });
    </script>
</body>
</html>
